{% extends "_admin_base.html" %}

{% block title %}{{ episode.title }}{% endblock %}

{% block content %}
    <label>Blurb<label>
    <textarea>{{ episode.blurb }}</textarea>

    <h4>New joke <a href="#" class="btn btn btn-info show-form"><i class="icon-plus icon-white"></i></a></h4>
    <div id="new" class="clearfix" style="display:none;">
        <div class="row-fluid">
            <p class="span12"><label>Joke</label>
                <input class="typeahead" type="text" data-provide="typeahead" data-items="10"></input>
                <p id="selected" style="display:none;"></p>
            </p>
        </div>
        <div class="row-fluid">
            <p class="span12"><label>Details</label> <textarea></textarea></p>
        </div>
        <div class="row-fluid">
            <p class="span3"><label>Type</label>
                <select>
                    <option value="1">mention</option>
                    <option value="f">foreshadowing</option>
                    <option value="b">background</option>
                </select>
            </p>
            <p class="span6"><a href="#" class="btn btn-success btn save">Save</a></p>
        </div>
        <div class="row-fluid">

        </div>
    </div>

    <h4>Jokes</h4>
    <div id="joke-list">
        {% for ej in episodejokes %}
            {% include '_episodejoke_form_row.html' %}
        {% endfor %}
    </div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript">
        $('.typeahead').typeahead({
            'source': [{% for joke in jokes %}"{{ joke.code }}: {{ joke.text }}<br/>{{ joke.blurb }}",{% endfor %}],
            'updater': function(item){
                $('#selected').attr('data-joke-code', item.split(':')[0]);
                $('#selected').html('<a href="#" id="kill-new-ej" class="btn btn-mini btn-danger">X</a>' + item);
                $('#new input.typeahead').toggle();
                $('#selected').toggle();
            }
        });
        $('a.show-form').on('click', function(){
            $('#new').toggle();
        });
        $('#new').on('click', 'a#kill-new-ej', function(){
            $('#new input.typeahead').toggle();
            $('#selected').toggle();
            return false;
        });
        $('#joke-list').on('click', 'a.delete', function(){
            data = {}
            data['episode_joke_id'] = parseInt($(this).attr('data-episodejoke-id'));
            $.ajax('episodejoke/', {
                'async': true,
                'cache': false,
                'data': data,
                'type': 'POST',
                'success': function(response){
                    var $deathElement = $('div#episodejoke-' + response);
                    $deathElement.remove();
                }
            });
            return false;
        });
        $('a.save').on('click', function(){
            data = {}
            data['joke_code'] = $('#new .selected').attr('data-joke-code');
            data['details'] = $('#new textarea').val();
            data['type'] = $('#new option:selected').attr('value');

            $.ajax('episodejoke/', {
                'async': true,
                'cache': false,
                'data': data,
                'type': 'PUT',
                'success': function(response){
                    $('#selected').html('');
                    $('#selected').attr('data-joke-code', '');
                    $('#new textarea').val('');
                    $('#new option:selected').removeAttr('selected');
                    $('#joke-list').append(response);
                }
            });
            return false;
        });
    </script>
{% endblock %}